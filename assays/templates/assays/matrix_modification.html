{# NEEDS TO BE REFACTORED #}
{% extends "base.html" %}
{% load static %}

{% block extra_head %}
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
{% endblock %}

{% block load_js %}
    <script src="{% static "js/split_time.js" %}"></script>
    <script src="{% static "assays/grouping_filtering.js" %}"></script>
    <script src="{% static "assays/organ_model_filter.js" %}"></script>
    <script src="{% static "assays/cell_sample_selection.js" %}"></script>
    <script src="{% static "assays/chart_display.js" %}"></script>
    {# Not used in detail, but shouldn't be problem #}
    <script src="{% static "js/calendar.js" %}"></script>
    <script src="{% static "js/enter_override.js" %}"></script>
    <script src="{% static "assays/compound_instances.js" %}"></script>
    <script src="{% static "js/flag.js" %}"></script>
    <script src="{% static "assays/matrix_modification.js" %}"></script>
{% endblock %}

{% block breadcrumbs %}
    {% if not detail %}
    <li><a href="/assays/assaystudy/editable_studies/">Editable Studies</a></li>
    {% else %}
    <li><a href="/assays/assaystudy/">Studies</a></li>
    {% endif %}
    <li><a href="{{ form.instance.study.get_absolute_url }}">{{ form.instance.study }}</a></li>
    <li class="active">
        {% if update %}
            Edit <em>{{ object }}</em>
        {% elif detail %}
            Matrix <em>{{ object }}</em>
        {% else %}
            Add Matrix
        {% endif %}
    </li>
{% endblock %}

{% block sidebar %}
    {% if update %}
    {% include 'assays/grouping_filtering.html' with charts="true" %}
    {% endif %}
{% endblock %}

{# TODO MAKE SURE FLUID CONTENT STUFF IS NEAT #}
{% block fluid-content %}
    <div class="container">
    {% if update %}
        <form enctype="multipart/form-data" class="form-horizontal" method="post" >
        <h1>
            Edit Matrix <em>{{ object }}</em>
    {# TODO #}
    {% elif detail %}
        <form enctype="multipart/form-data" class="form-horizontal" method="post" >
        <h1>
            Matrix <em>{{ object }}</em>
    {% else %}
        <form enctype="multipart/form-data" class="form-horizontal" method="post" >
        <h1>
            Add Matrix
    {% endif %}
    {% csrf_token %}
        </h1>

    {# TODO REVISIONS TO MAKE THIS A DETAIL PAGE AS WELL #}

    {% include "submit.html" with flag="y" group=study.group.name %}

    {% include 'errors.html' %}

    {% include 'tracking.html' %}

    {% include "sign_off_form.html" with group=form.instance.study.group.name %}

    <legend>Matrix Details</legend>

    {% include 'generic_field.html' with field=form.name label="Matrix Name*" %}

    {% include 'generic_field.html' with field=form.notes label="Notes" %}

    {% include 'generic_field.html' with field=form.representation label="Representation*" %}

    <div hidden id="matrix_device_and_model_section" class="matrix-section">
    {% include 'generic_field.html' with field=form.device label="Device" %}
    </div>

    <div hidden id="matrix_dimensions_section" class="matrix-section">
    {% include 'generic_field.html' with field=form.number_of_items label="Number of Items" %}

    {# Dimensions should be on one line if possible #}
    {% if form.number_of_rows.errors or form.number_of_columns.errors  %}
        {% for error in form.number_of_rows.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ error }}
            </div>
        {% endfor %}
        {% for error in form.number_of_columns.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ error }}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="number_of_rows" class="col-sm-2 col-md-2 control-label">Number of Rows</label>
        <div class="col-sm-3 col-md-2">
            {{ form.number_of_rows }}
         </div>
        <label for="number_of_columns" class="col-sm-3 col-md-2 control-label">Number of Columns</label>
        <div class="col-sm-4 col-md-6">
            {{ form.number_of_columns }}
        </div>
    </div>
    </div>

    </div>

    {# This section is a setup table similar to the new study page #}
    {# TODO PUT THE TABLE THING HERE #}
    {# TODO TODO VERY MUCH NOT DRY #}
    {# TODO PUT THE TABLE THING HERE #}
    <div id="study_setup_table_section">
            {# Section for visibility checkboxes #}
            {# A little awkward #}
            <div class="row large-padding-top">
            <div class="col-md-4 col-lg-3">
                <div class="fancy-checkbox table-filter padded-bottom" align="left">
                    <input class="visibility-checkbox" type="checkbox" name="show_cells" id="show_cells" value=".cell_start" checked/>
                    <div class="btn-group">
                        <label for="show_cells" class="btn btn-success">
                            <span class="glyphicon glyphicon-ok"></span>
                            <span> </span>
                        </label>
                        <label for="show_cells" class="btn btn-default active">
                            Show Cells
                        </label>
                    </div>
                </div>
            </div>

            <div class="col-md-4 col-lg-3">
                <div class="fancy-checkbox table-filter padded-bottom" align="left">
                    <input class="visibility-checkbox" type="checkbox" name="show_compounds" id="show_compounds" value=".compound_start" checked/>
                    <div class="btn-group">
                        <label for="show_compounds" class="btn btn-info">
                            <span class="glyphicon glyphicon-ok"></span>
                            <span> </span>
                        </label>
                        <label for="show_compounds" class="btn btn-default active">
                            Show Compounds
                        </label>
                    </div>
                </div>
            </div>

            <div class="col-md-4 col-lg-3">
                <div class="fancy-checkbox table-filter padded-bottom" align="left">
                    <input class="visibility-checkbox" type="checkbox" name="show_settings" id="show_settings" value=".setting_start" checked/>
                    <div class="btn-group">
                        <label for="show_settings" class="btn btn-warning">
                            <span class="glyphicon glyphicon-ok"></span>
                            <span> </span>
                        </label>
                        <label for="show_settings" class="btn btn-default active">
                            Show Settings
                        </label>
                    </div>
                </div>
            </div>
            </div>

            <div class="row">
                <div class="col-md-4 col-lg-3">
                    <div class="fancy-checkbox table-filter padded-bottom" align="left">
                        {# useless value #}
                        <input type="checkbox" name="show_details" id="show_details" value=".full_details" />
                        <div class="btn-group">
                            <label for="show_details" class="btn btn-default">
                                <span class="glyphicon glyphicon-ok"></span>
                                <span> </span>
                            </label>
                            <label for="show_details" class="btn btn-default active">
                                Show Full Details
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3" hidden>
                    <div class="fancy-checkbox table-filter padded-bottom" align="left">
                        <input class="visibility-checkbox" type="checkbox" name="show_errors" id="show_errors" value=".error-display" checked/>
                        <div class="btn-group">
                            <label for="show_settings" class="btn btn-warning">
                                <span class="glyphicon glyphicon-ok"></span>
                                <span> </span>
                            </label>
                            <label for="show_errors" class="btn btn-danger active">
                                Show Errors
                            </label>
                        </div>
                    </div>
                </div>
                {# Spacer, contrived #}
                <div class="col-md-4 col-lg-3"></div>
            </div>

        {# Set of buttons for adding cells, compounds, settings etc. #}
        <div class="padded-bottom">
        <a role="button" class="btn btn-success" id="add_series_button"><span class="glyphicon glyphicon-plus-sign"></span>Add Series</a>
        </div>

        <div class="padded-bottom">
        <a role="button" class="btn btn-success" data-add-new-button="true" data-prefix="cell">Add Cell</a>
        <a role="button" class="btn btn-success" data-add-new-button="true" data-prefix="compound">Add Compound</a>
        {# Probably will be renamed #}
        <a role="button" class="btn btn-success" data-add-new-button="true" data-prefix="setting">Add Setting</a>
        </div>

        {# Avoid inline styles #}
        <div class="overflow-auto" style="margin-bottom: 100px;">
        {# Contrived inline style #}
        <table style="min-width: 1000px; margin-bottom: 0px;" class="table table-striped table-bordered table-nonfluid" id="study_setup_table">
            <thead>
                <th>Series</th>
                <th>MPS Model</th>
                <th>Test Type</th>
                <th hidden class="cell_start"></th>
                <th hidden class="compound_start"></th>
                <th hidden class="setting_start"></th>
            </thead>
            <tbody></tbody>
        </table>
        </div>
    </div>

    <div class="well padded-bottom">
        {# For now, let's just set a min-width of 1000px #}
        <div id="matrix_wrapper" class="overflow-scroll" style="max-height:950px;">
            <table id="matrix_table" class="table" style="min-width:1000px;">
                <tbody id="matrix_body"></tbody>
            </table>
        </div>
    </div>

    {# TODO CHANGE #}
    <div hidden>
        {# OLD #}
        {# {{ form.setup_data }} #}
        {{ form.series_data }}
    </div>

    </form>
    {# End FORMS #}

    {# CHARTING STUFF #}

    {# Don't put charts in a container? #}
    {% if update %}
    {% include 'assays/sidebar_extras.html' with show_hide="true" %}

    {# Note indicating no data to display initially #}
    <div id="charts" class="padded-bottom">
        No data to display
    </div>

    {% include 'assays/group_table.html' %}
    {% endif %}

    {% include 'assays/revised_group_editing.html' %}
{% endblock %}
